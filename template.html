<!-- Fix for Bootstrap css with Google Maps https://github.com/twitter/bootstrap/issues/1552 -->
<style type="text/css">
    .map_canvas label {
        width: auto;
        display: inline;
    }
    .map_canvas img {
        max-width: none;
    }
    .map_cnt {
        position: relative;
        border: 1px solid rgb(0, 0, 0.1);
        box-shadow: 0 0 5px #888;
    }
    .map_btn {
        text-align: center;
        position: absolute;
        overflow: hidden;
        top: 0;
        left: 0;
        opacity: 0;
        background-color: rgba(51,51,51, 0.7); 
        z-index: 999;
        transition: all 0.4s ease-in-out;
    }
    .map_btn h3 {
        text-transform: uppercase;
        color: #fff;
        text-align: center;
        position: relative;
        font-size: 17px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.6);
        margin: 20px 0 0 0
    }
    .map_btn p {
        color: #fff;
        text-align: center;
        position: relative;
        font-size: 14px;
        padding-top: 10px;
    }
    .map_btn button{
        margin-top: 10%;
    }
    .map_btn:hover {
        opacity: 1;
    }
    .layersDiv label {
        color: white;
    }
    .olControlOverviewMapElement {
        background-color: white;
    }
    .maps {
        width: 95%;
        height: 400px;
        border: 1px solid black;
    }
    .center {
        margin-left:auto;
        margin-right:auto;
        width:70%;
    }
</style>

<div class="row">
  <!-- Success and Error Messages for the user --> 
  <!-- Question, task id, image and action buttons for answering the question-->
  <div class="span12" style="height:50px;">
    <div id="success" class="alert alert-success" style="display:none;">
      <a class="close">×</a>
      <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
      <strong>The task has been completed!</strong> Thanks a lot!</strong>
    </div>
    <div id="finish" class="alert alert-success" style="display:none;">
      <strong>Congratulations!</strong> You have participated in all available tasks!</strong>
      <br/>
      <div class="alert-actions">
              <a class="btn small" href="/">Go back</a>
              <a class="btn small" href="/app">or, Check other applications</a>
      </div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
      <a class="close">×</a>
      <strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
    <div id="warning" class="alert alert-warning" style="display:none;">
      <a class="close">×</a>
      <strong>Oooops!</strong> Image not found, trying with a new one!</strong>
    </div>
  </div>
</div>

<!-- Header of the task -->
<div class="row">
  <div class="skeleton span8">
    <div id="question">
      <h1>Question</h1>
    </div>
  </div>
  <div class="skeleton span2">
      <!-- Change margin-top to align button with H1-->
      <div style="margin-top:5px">
        <a href="../tutorial" class="btn btn-info btn-large"> Tutorial</a>
      </div>
  </div>
</div>

<div class="row skeleton">
    <div class="span12">
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
        <span id="total" class="label label-inverse"></span> You are now working in Task: <span id="task-id" class="label label-warning">#</span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
    </div>
</div>

<div align="center">
    <div class="row skeleton">
        <div class="span6">
            <div class="maps" id="map1"></div>
        </div>
        <div class="span6">
            <div class="maps" id="map2"></div>
        </div>
    </div>
</div>
<br/>
<div align="center">
    <div align="center">
        <div class="row">
            <div class="span6">
                <button class="btn btn-large btn-success h3" value="forest" onclick="changeToGreen();" id="btnForest">Forest</button>
            </div>
            <div class="span6">
                <button class="btn btn-large btn-danger" value="non-forest" onclick="changeToRed();" id="btnNonForest">Non-forest</button>
            </div>
        </div>
        <br />
        <!--div class="row">
            <div class="span12">
                <button class="btn btn-large " value="reset" onclick="reset();">Reset</button>
            </div>
        </div>
        <br /-->
        <div class="row">
            <div id="areaBtnSubmit" class="span12" style="display:none;">
                <button class="btn btn-large btn-submit btn-primary" value="submit" onclick="submitTask();" id="btnSubmit">Submit</button>
            </div>
        </div>
    </div>
</div>
<br/>

<!-- PyBossa interface -->
<script src="/static/openlayers/OpenLayers.js"></script>
<script src="http://mustache.github.com/extras/mustache.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<script>
    var map1, map2, map3, layerBestTile1, layerBestTile2, layerBestTile3, vector1, vector2, vector3;
    var circleFeature1, circleFeature2, circleFeature3, vectorLayer1, vectorLayer2, vectorLayer3, center1, center2, center3, point
    var projection, lon, lat, pointInterestG, pointInterestL, sizeSquare
    var selected_polygon_style_red, selected_polygon_style_blue, bboxSelected
    var selected_polygon_style_blue_green, selected_polygon_style_blue_red
    var mapfile = "map=/home/eduardo/ForestWatchers/maps/maps2012.map"
    var infofile = "map=/home/eduardo/ForestWatchers/maps/infoshapes.map"
    var server = "http://localhost/cgi-bin/mapserv?"
    var resultserver = server + mapfile
    var infoserver = server + infofile
    var activeMove = false
    var initMap1, initMap2, result

    /* Red-Blue line styles */
    sizeSquare = 0.0045
    selected_polygon_style_red = {
        strokeWidth: 4,
        strokeColor: '#ff0000',
        fillOpacity: 0
    };
    selected_polygon_style_blue = {
        strokeWidth: 4,
        strokeColor: '#104e8b',
        fillOpacity: 0
    };
    selected_polygon_style_blue_green = {
        strokeWidth: 4,
        strokeColor: '#104e8b',
        fillColor: '#00ff00',
        fillOpacity: 1
    };
    selected_polygon_style_blue_red = {
        strokeWidth: 4,
        strokeColor: '#104e8b',
        fillColor: '#ff0000',
        fillOpacity: 1
    };

    /* Load the task data into the HTML skeleton */
    function loadTask ( task_id ) {
        var t = $.ajax({
            url: '/api/task/'+task_id,
            dataType: 'json'
        });

        t.done( function (task) {
            if ( !$.isEmptyObject(task) ) {
                if (task.state=='completed') {
                    $('#controls').hide();
                    $('#answer').hide();
                    $('#disqus_thread').hide();
                    $('#taskcompleted').show();
                }

                var lat = task.info.tile.lat;
                var lon = task.info.tile.lon;
                pointInterestG = new OpenLayers.Geometry.Point(lon, lat);
                pointInterestL = new OpenLayers.LonLat(lon, lat);

                $("#question h1").text(task.info.question);
                loadUserProgress();
                $("#task-id").text(task.id);

                /* Initialize maps */
                init();

                /* Submit button initializes as disabled
                $("#btnSubmit").hide(); */

            }
            else {
                $(".skeleton").hide();
                $("#finish").fadeIn();
            }
        });
    }

    var taskId = pybossa.getCurrentTaskId(window.location.pathname);
    if (taskId){
        loadTask(taskId);
    }
    else {
        pybossa.newTask("checkClassRO", "http://localhost:5000").done( function( data ) { 
            if ( !$.isEmptyObject(data.task) ) {
                window.location.pathname = "/app/checkClassRO/task/" + data.task.id;
            }
           else {
                $(".skeleton").hide();
                $("#finish").fadeIn();
            }
        });
    }

    function loadUserProgress() {
        pybossa.userProgress('checkClassRO', 'http://localhost:5000').done(function(data){
            var pct = Math.round((data.done*100)/data.total);
            $("#progress").css("width", pct.toString() +"%");
            $("#progress").attr("title", pct.toString() + "% completed!");
            $("#progress").tooltip({'placement': 'top'}); 
            $("#total").text(data.total);
            $("#done").text(data.done);
        });
    }

    /* Saves the answer for the given task */
    function submitTask() {
        task_id = $("#task-id").text();
        console.log(result);
        pybossa.saveTask( task_id, {'checkClassRO': result}, "http://localhost:5000").done( function(data) {
            /* Show the feedback div */
            $("#success").fadeIn();
            /* Fade out the pop-up after a 1000 miliseconds */
            debugger;
            setTimeout(function() { $("#success").fadeOut() }, 1000);
            /* Request a new task */
            window.location.pathname = '/app/checkClassRO/newtask';
        });
    }

    /* Change polygon to green and enable submit button */
    function changeToGreen(){
        circleFeature2.style = selected_polygon_style_blue_green;
        vectorLayer2.drawFeature(circleFeature2);
        result = 1;
        /* $("#btnSubmit").css({visibility: "visible"}).animate({opacity: 1}, 500); */
        $("#areaBtnSubmit").fadeIn();
    }

    /* Change polygon to red and enable submit button */
    function changeToRed(){
        circleFeature2.style = selected_polygon_style_blue_red;
        vectorLayer2.drawFeature(circleFeature2);
        result = 2;
        /* $("#btnSubmit").css({visibility: "visible"}).animate({opacity: 1}, 500); */
        $("#areaBtnSubmit").fadeIn();
    }

    /* Reset the maps */
    function reset(){
        map1 = initMap1;
        map2 = initMap2;
    }

    function init(){
        /*Map1*/
        map1 = new OpenLayers.Map( 'map1' );
        layerBestTile1 = new OpenLayers.Layer.WMS( "Sattelite mosaic", resultserver, 
          {
            layers: 'annBuild',
            isBaseLayer: true
           },
          {
            opacity: 1.0
          } );
        vector1 = new OpenLayers.Layer.WMS( "Brazil (political map)", infoserver, 
          {
            layers: 'shp_brazil',
            transparent: true
          }, {
            opacity: 0.4
           } );
        center1 = new OpenLayers.Geometry.Polygon.createRegularPolygon(pointInterestG, sizeSquare, 4, 0);
        circleFeature1 = new OpenLayers.Feature.Vector(center1);
        circleFeature1.style = selected_polygon_style_red;
        vectorLayer1 = new OpenLayers.Layer.Vector("Interest Area");
        vectorLayer1.addFeatures(circleFeature1);
        map1.addLayer(vectorLayer1);
        map1.addLayer(layerBestTile1);
        map1.addLayer(vector1);
        map1.setCenter(pointInterestL,13);
        map1.addControl(new OpenLayers.Control.LayerSwitcher());
        initMap1 = map1

        /*Map2*/
        map2 = new OpenLayers.Map( 'map2' );
        layerBestTile2 = new OpenLayers.Layer.WMS( "ANN classification", resultserver, 
          {
            layers: 'annClass',
            isBaseLayer: true
           },
          {
            opacity: 1.0
          } );
        vector2 = new OpenLayers.Layer.WMS( "Brazil (political map)", infoserver, 
          {
            layers: 'shp_brazil',
            transparent: true
          }, {
            opacity: 0.4
           } );
        center2 = new OpenLayers.Geometry.Polygon.createRegularPolygon(pointInterestG, sizeSquare, 4, 0);
        circleFeature2 = new OpenLayers.Feature.Vector(center2);
        circleFeature2.style = selected_polygon_style_blue;
        vectorLayer2 = new OpenLayers.Layer.Vector("Interest Area");
        vectorLayer2.addFeatures(circleFeature2);
        map2.addLayer(vectorLayer2);
        map2.addLayer(layerBestTile2);
        map2.addLayer(vector2);
        map2.setCenter(pointInterestL,13);
        map2.addControl(new OpenLayers.Control.LayerSwitcher());
        initMap2 = map2

        /* Sync maps */
        map1.events.register("move", map1, function(){
            if (activeMove) {
                return;
            }
            activeMove = true;
            map2.setCenter(map1.getCenter().clone().transform(map1.getProjectionObject(), map2.getProjectionObject()), map1.getZoom());
            activeMove = false;
        });
        map2.events.register("move", map2, function(){
            if (activeMove) {
                return;
            }
            activeMove = true;
            map1.setCenter(map2.getCenter().clone().transform(map2.getProjectionObject(), map1.getProjectionObject()), map2.getZoom());
            activeMove = false;
        });

    };

</script>
